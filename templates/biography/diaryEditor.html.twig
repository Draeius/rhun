<link href="{{asset('bundles/codemirror/codemirror.css')}}" rel='stylesheet' type='text/css' />

<script src="{{asset('bundles/codemirror/codemirror.js')}}"></script>
<script src="{{asset('bundles/codemirror/CMAutoRefresh.js')}}"></script>
<script src="{{asset('bundles/codemirror/javascript/javascript.js')}}"></script>
<script src="{{asset('bundles/codemirror/xml/xml.js')}}"></script>

<script>

    var charId = 0;
    var refreshBioList = false;

    function selectChar(id) {
        if (id) {
            charId = id;
            document.getElementById('selectedChar').value = id;
            var con = new ajax.AjaxConnector();
            con.getData('diary/get/entries', {charId: id}, function (data) {
                $(document.forms.diary.elements["id"]).html("");
                $(document.forms.diary.elements["id"]).append($('<option value="null"></option>').html("Einen Eintrag auswählen"));
                for (var index in data) {
                    var option = $('<option value="' + data[index]['id'] + '"></option>').html(data[index]['title']);
                    $(document.forms.diary.elements["id"]).append(option);
                }

                document.getElementById('diary_editor').style.display = "block";
            });
        }
    }

    function selectDiaryEntry(id) {
        if (id == null) {
            return;
        }
        var con = new ajax.AjaxConnector();
        con.getData("diary/get/data", {'id': id}, function (data) {
            if (data['script'] != null) {
                scriptArea.getDoc().setValue(data['script']);
            }
            if (data['text'] != null) {
                diaryArea.getDoc().setValue(data['text']);
            }
            document.forms.diary.elements["title"].value = data["title"];
        });
    }

    function submitForm(name) {
        if (name !== 'add_diary') {
            document.forms.diary.elements["script"].innerHTML = scriptArea.getValue();
            document.forms.diary.elements["text"].innerHTML = diaryArea.getValue();
        }
        var refreshBioList = name === 'add_diary' || name === 'delete_diary';

        var con = new ajax.AjaxConnector();
        var form = $("form[name='" + name + "']").get(0);
        con.submitForm(form, function () {
            callback(refreshBioList);
        });
        return false;
    }

    function deleteBio() {
        document.forms.delete_diary.elements['id'].value = document.forms.diary.elements['id'].value;
        if (confirm(unescape("Willst du den Eintrag wirklich l%F6schen%3F Der Inhalt ist f%FCr immer weg. Das ist eine lange Zeit."))) {
            submitForm('delete_diary');
        }
        return false;
    }

    function checkScript() {
        $("#preview_script").replaceWith($("<script>" + scriptArea.getValue() + "<\/script>").attr("id", "preview_script"));
    }

    function callback(refreshBioList) {
        if (refreshBioList) {
            selectChar(charId);
        } else {
            alert('Der Eintrag wurde gespeichert.');
        }
    }
</script>

<span style="color: red">Bitte wähle zunächst einen deiner Charaktere aus, für den du einen Tagebucheintrag schreiben willst.</span><br />
<select onchange="selectChar(this.value)">
    <option value="null">Einen Charakter auswählen</option>
    {% for char in characters %}
        <option value="{{ char.getId() }}" {% if char.getId() == selectedChar %} selected {% endif %}>{{ char |charName |colorize |raw }}</option>
    {% endfor %}
</select>



<div id="diary_editor" style="display: none">
    <h4>Tagebucheintrag hinzufügen:</h4>
    <span style="color: green">Du kannst einen Tagebucheintrag zu deiner Auswahl hinzufügen, indem du hier einen Titel dafür eingibst.</span><br />
    <form action="{{path('diary_add')}}" name="add_diary" method="POST">
        Titel des Eintrags:<br />
        <input name="title" value="Neuer Eintrag" /><br />
        <input id="selectedChar" type="hidden" name="character" value="null" />
    </form>
    <input type="button" value="Hinzufügen" onclick="return submitForm('add_diary');" />

    <form name="diary" action="{{path('diary_edit')}}" method="POST" >
        <h4>Tagebucheintrag wählen:</h4>
        <span style="color: green">Wähle hier einen Eintrag aus, den du bearbeiten möchtest. Wenn du noch keinen hast, musst du zuerst oben einen hinzufügen.</span><br />
        <table>
            <tr>
                <td>
                    <select name="id" onchange="selectDiaryEntry(this.value)">
                        <option value="null">Einen Eintrag auswählen</option>
                    </select> 
                </td>
                <td>
                    <input type="button" value="Löschen" onclick="deleteBio()" />
                </td>
            </tr>
        </table>
        <br />

        Titel:<br />
        <input name="title" size="50" /><br /><br />

        <h4>Script (optional)</h4>
        <span style="color: green">Hier kannst du alles an JavaScript reinschreiben, was deine Seite so braucht (ein script tag brauchst du nicht angeben).<br />
            Alle script elemente in deiner Biographie werden entfernt werden.</span><br />
        <p>Rhun stellt dir diverse Möglichkeiten zur Gestaltung deiner Biographie zur Verfügung. Wenn du mehr erfahren willst, dann klicke bitte 
            <a href="biohelp.php" target="_blank">hier.</a></p>
        <textarea id="script_area" name="script"></textarea>
        
        <h4>Tagebucheintrag</h4>
        <span style="color: green">Hier kannst du den Inhalt deines Tagebucheintrages reinschreiben.</span><br /><br />
        <a class="clickable"  style="font-size: 1.2em;" href="/colorlist" target="_blank">{{ '`pF`ea`Nr`Gb`Le`Kn`Ll`Gi`Ns`et`pe' |colorize |raw }}</a><br /><br />
        <textarea id="diary_area" name="text"></textarea>
    </form>
    <br /><br />
    <input type="button" value="Eintrag speichern" onclick="return submitForm('diary');"/>

    <script id="preview_script">

    </script>

    <input type="button" value="Script ausprobieren" onclick="checkScript()"/>

    <h3>Vorschau:</h3>
    <div id="preview">

    </div>
</div>

<form name="delete_diary" action="{{path('diary_del')}}" method="POST" >
    <input type="hidden" name="id" />
</form>
<script>
    var scriptArea = CodeMirror.fromTextArea(document.getElementById("script_area"), {
        lineNumbers: true,
        mode: "text/javascript",
        autoRefresh: true,
    });
    var diaryArea = CodeMirror.fromTextArea(document.getElementById("diary_area"), {
        lineNumbers: true,
        mode: "text/html",
        autoRefresh: true,
    });
    
    var preview = new formatting.Preview(diaryArea, document.getElementById("preview"));
    diaryArea.on("keyup", function (cm, keyup) {
        preview.update();
    });
    {% if selectedChar %}
        $(document).ready(function () {
            selectChar({{selectedChar}});
        });
    {% endif %}
</script>
